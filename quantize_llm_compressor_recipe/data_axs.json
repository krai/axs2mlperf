{
    "_parent_entries": [ [ "^", "byname", "python_script" ], [ "^", "byname", "entry_creator" ] ],
    "_producer_rules": [
        [ [ "quantized", "method=llm_compressor" ], [[ "get", "pipeline" ]] ]
    ],

    "pipeline": [ "^^", "execute", [[
        [ "run" ],
        [ ],
        [ "get", "stored_newborn_entry" ]
    ]] ], 

    "desired_python_version": "3.11",

    "model_name": "llama3_1",
    "model_variant": "8b",
    "conversion_method": "transformers",

    "source_model_query": [ "^^", "substitute", [[
        "converted",
        [ "method", "#{conversion_method}#" ],
        [ "model_name", "#{model_name}#" ],
        [ "model_variant", "#{model_variant}#" ]
    ]] ],
    "source_model_entry": [ "^", "byquery", 
        [[ "^^", "get", "source_model_query" ]], {}, [ "source_model_query" ]
    ],
    "source_model_path": [ "^^", "execute", [[
        [ "get", "source_model_entry" ],
        [ "get_path" ]
    ]] ],

    "target_model_path": [ "^^", "get", "newborn_entry_path" ],

    "dataset_name": "cnndm",
    "calib_dataset_query": [ "^^", "substitute", [[
        "downloaded",
        [ "dataset_name", "#{dataset_name}#" ],
        [ "model_family", "#{model_name}#" ],
        [ "variant", "#{model_variant}#" ],
        [ "type", "calibration" ]
    ]] ],
    "calib_dataset_entry": [ "^", "byquery", 
        [[ "^^", "get", "calib_dataset_query" ]], {}, [ "calib_dataset_query" ]
    ],
    "calib_dataset_path": [ "^^", "execute", [[
        [ "get", "calib_dataset_entry" ],
        [ "get_path" ],
        [ "__add__", "/cnn_dailymail_calibration.json" ]
    ]] ],

    "num_gpus": 1,
    "max_sequence_length": 4096,
    "num_calibration_samples": 1000,

    "python_deps": [
        [ "^^", "python_sync_pip_package", [[
            "python_package",
            "package_name=compressed-tensors",
            "package_version=0.5.0",
            ["desired_python_version", [ "^^", "get", "desired_python_version" ] ]
        ]] ],
        [ "^^", "python_sync_pip_package", [[ 
            "python_package",
            "package_name=llm-compressor",
            "installable=git+https://github.com/vllm-project/llm-compressor.git@sa/big_model_support",
            ["desired_python_version", [ "^^", "get", "desired_python_version" ] ]
        ]] ]
    ],

    "newborn_parent_names": [ "base_safetensors_model" ],
    "newborn_entry_tags": [ "quantized", "method=llm_compressor" ],
    "newborn_name_template": [ "quantized_#{model_name}#_#{model_variant}#_using_#{method}#" ],
    "newborn_entry_param_names": [
        "model_name",
        "model_variant"
    ],

    "rel_script_path": "quantize.py",

    "script_extra_params": [ "^^", "substitute", 
        "#{source_model_path}# #{target_model_path}# #{calib_dataset_path}# #{num_gpus}# #{max_sequence_length}# #{num_calibration_samples}#"
    ]
}
