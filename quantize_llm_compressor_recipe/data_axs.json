{
    "_parent_entries": [ [ "^", "byname", "entry_creator" ] ],
    "_producer_rules": [
        [ [ "quantized", "method=llm_compressor" ], [[ "get", "pipeline" ]] ]
    ],

    "pipeline": [ "^^", "execute", [[
        [ "quantize" ],
        [ ],
        [ "get", "stored_newborn_entry" ]
    ]] ], 

    "model_name": "llama3_1",
    "model_variant": "8b",
    "conversion_method": "transformers",

    "source_model_query": [ "^^", "substitute", [[
        "converted",
        [ "method", "#{conversion_method}#" ],
        [ "model_name", "#{model_name}#" ],
        [ "model_variant", "#{model_variant}#" ]
    ]] ],
    "source_model_entry": [ "^", "byquery", 
        [[ "^^", "get", "source_model_query" ]], {}, [ "source_model_query" ]
    ],
    "source_model_path": [ "^^", "execute", [[
        [ "get", "source_model_entry" ],
        [ "get_path" ]
    ]] ],

    "target_model_path": [ "^^", "get", "newborn_entry_path" ],

    "dataset_name": "cnndm",
    "calib_dataset_query": [ "^^", "substitute", [[
        "downloaded",
        [ "dataset_name", "#{dataset_name}#" ],
        [ "model_family", "#{model_name}#" ],
        [ "variant", "#{model_variant}#" ],
        [ "type", "calibration" ]
    ]] ],
    "calib_dataset_entry": [ "^", "byquery", 
        [[ "^^", "get", "calib_dataset_query" ]], {}, [ "calib_dataset_query" ]
    ],
    "calib_dataset_path": [ "^^", "execute", [[
        [ "get", "calib_dataset_entry" ],
        [ "get_path" ]
    ]] ],

    "num_gpus": 1,
    "max_sequence_length": 4096,
    "num_calibration_samples": 1000,

    "transformers_query": [ "python_package", "package_name=transformers", "package_version=4.43.2", ["desired_python_version", ["^", "kernel_python_major_dot_minor"]] ],
    "torch_query":  [ "python_package", "package_name=torch", "package_version=2.4.0",  ["desired_python_version", ["^", "kernel_python_major_dot_minor"]] ],
    "llm_compressor_query":  [ "python_package", "package_name=llm-compressor", "installable=git+https://github.com/vllm-project/llm-compressor.git@sa/big_model_support",  ["desired_python_version", ["^", "kernel_python_major_dot_minor"]] ],
    "compressed_tensors_query":  [ "python_package", "package_name=compressed-tensors", "package_version=0.5.0",  ["desired_python_version", ["^", "kernel_python_major_dot_minor"]] ],

    "_BEFORE_CODE_LOADING": [ "^^", "execute", [[
        ["get_kernel"],
        ["byquery", [[ "^^", "get", "transformers_query" ]] ],
        ["use"],
        [],
        ["get_kernel"],
        ["byquery", [[ "^^", "get", "torch_query" ]] ],
        ["use"],
        [],
        ["get_kernel"],
        ["byquery", [[ "^^", "get", "llm_compressor_query" ]] ],
        ["use"],
        [],
        ["get_kernel"],
        ["byquery", [[ "^^", "get", "compressed_tensors_query" ]] ],
        ["use"],
        []
    ]] ],

    "newborn_entry_tags": [ "quantized", "method=llm_compressor" ],
    "newborn_name_template": [ "quantized_#{model_name}#_#{model_variant}#_using_#{method}#" ],
    "newborn_entry_param_names": [
        "model_name",
        "model_variant"
    ]
}