{
    "_parent_entries": [ [ "^", "byname", "python_script" ], [ "^", "byname", "base_loadgen_program" ] ],
    "_producer_rules": [
        [ [ "loadgen_output", "gptj_cnndm", "framework=torch" ], [["run"]], { "return_saved_record_entry": true } ]
    ],

    "mlperf_inference_git_entry": [ "^", "byquery", "git_repo,repo_name=mlperf_inference_git" ],

    "gptj_code_dir": [ "^^", "execute", [[
        [ "get", "mlperf_inference_git_entry" ],
        [ "get_path_of", "gptj_code_dir" ]
    ]] ],

    "python_deps": [
        [ "^", "byquery", "python_package,package_name=mlperf_loadgen" ],
        [ "^^", "python_sync_pip_package", [[ "python_package", "package_name=numpy" ]] ],
        [ "^^", "python_sync_pip_package", [[ "python_package", "package_name=pillow" ]] ],
        [ "^^", "python_sync_pip_package", [[ "python_package", "package_name=torch" ]] ],
        [ "^^", "python_sync_pip_package", [[ "python_package", "package_name=datasets" ]] ],
        [ "^^", "python_sync_pip_package", [[ "python_package", "package_name=transformers" ]] ]
    ],

    "loadgen_scenario": "SingleStream",
    "loadgen_dataset_size": 10,
    "loadgen_buffer_size": 1,
    "desired_python_version": 3.9,

    "loadgen_count_override_min": 64,
    "loadgen_target_latency": 2000,

    "model_name": "gptj",
    "model_path": "/data/gpt-j/model/",

    "dtype": "bfloat16",
    "num_beams": 2,

    "output_entry": [ "^^", "execute", [[
        [ "get", "__record_entry__" ],
        [ "plant", [
                "_parent_entries", [ "AS^IS", "AS^IS", [ "^", "byname", "base_gptj_loadgen_experiment" ] ],
                "tags", [ "loadgen_output", "gptj_cnndm" ]
            ] ],
        [ "plant", [ "^^", "slice", [
                            "loadgen_scenario",
                            "loadgen_mode",
                            "loadgen_dataset_size",
                            "loadgen_buffer_size",
                            "loadgen_multistreamness",
                            "loadgen_mlperf_conf_path",

                            "model_name",
                            "model_path",

                            "framework",
                            "sut_name",
                            "program_name",

                            "num_beams",
                            "dtype"
                        ], {"plantable": true }
            ] ],
        [ "attach", [ "^", "work_collection" ] ],
        [ "save" ]
    ]] ],

    "output_entry_path": [ "^^", "execute", [[
        [ "get", "output_entry" ],
        [ "get_path", "" ]
    ]] ],

    "extra_env": {
        "LOG_PATH": [ "^^", "get", "output_entry_path" ],
        "NUMBER_OF_BEAMS": [ "^^", "get", "num_beams" ]
    },

    "dataset_path": [ "^", "execute", [[
        [ "byquery", "downloaded,dataset=cnndm_mlperf"],
        [ "get_path" ]
    ]] ],

    "accuracy_or_not": [ "^^", "case",[ ["^^", "get", "loadgen_mode"], "AccuracyOnly", "--accuracy" ], {"default_value": ""} ],

    "rel_script_path": [ "^^", "substitute", "#{gptj_code_dir}#/main.py" ],
    "script_extra_params": [ "^^", "substitute",
        "--mlperf_conf=\"#{loadgen_mlperf_conf_path}#\" --user_conf=\"#{loadgen_user_conf_path}#\" --scenario=#{loadgen_scenario}# --model-path=\"#{model_path}#\" --dataset-path=\"#{dataset_path}#\" --dtype=#{dtype}# --max_examples=#{loadgen_dataset_size}# #{accuracy_or_not}# --gpu"
    ]
}
